<html>

<body>
    <div id="content"></div>
    <div id="input">
        <style>
            #hiddenInput {
                position: absolute;
                top: 0;
                left: 0;
                width: 1px;
                height: 1px;
                opacity: 0;
                background: transparent;
                border: none;
                outline: none;
                color: transparent;
                z-index: 1000;
            }

            #subtitles {
                position: fixed;
                bottom: 50px;
                left: 50%;
                transform: translateX(-50%);
                color: black;
                font-size: 24px;
                text-align: center;
                padding: 15px 30px;
                border-radius: 10px;
                max-width: 80%;
                word-wrap: break-word;
                min-height: 60px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: border-color 0.3s ease;
            }
        </style>
        <input type="text" id="hiddenInput" autocomplete="off" spellcheck="false">
        <div id="subtitles" class="listening"></div>
        <script>
            let ws = new WebSocket('ws://104.196.149.166:8081');
            ws.onopen = function (event) {
                console.log('WebSocket connected');
            };
            ws.onmessage = function (event) {
                console.log('WebSocket onmessage', event.data);

                const data = JSON.parse(event.data);
                let contentDiv = document.getElementById('content');
                contentDiv.innerHTML = data.div_content;

                const scripts = contentDiv.getElementsByTagName('script');
                for (const script of scripts) {
                    const newScript = document.createElement('script');
                    newScript.textContent = script.textContent;
                    document.head.appendChild(newScript);
                    document.head.removeChild(newScript);
                }
                
                speechSynthesis.speak(new SpeechSynthesisUtterance(data.audio_message));
            };
            ws.onclose = function (event) {
                console.log('WebSocket closed');
            };
            ws.onerror = function (error) {
                console.error('WebSocket error:', error);
            };

            const hiddenInput = document.getElementById('hiddenInput');
            const subtitles = document.getElementById('subtitles');
            document.addEventListener('click', function (e) {
                if (e.target !== hiddenInput) {
                    hiddenInput.focus();
                }
            });
            document.addEventListener('touchstart', function (e) {
                if (e.target !== hiddenInput) {
                    hiddenInput.focus();
                }
            });
            hiddenInput.addEventListener('input', function () {
                const value = hiddenInput.value.trim();
                if (value) {
                    subtitles.textContent = value;
                } else {
                    subtitles.textContent = '';
                }
            });
            hiddenInput.addEventListener('focus', function () {
                subtitles.style.borderColor = 'rgba(255, 255, 255, 0.3)';
            });
            hiddenInput.addEventListener('blur', function () {
                subtitles.style.borderColor = 'transparent';
            });
            hiddenInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleEnterPress(hiddenInput.value);
                }
            });
            window.addEventListener('load', function () {
                hiddenInput.focus();
            });

            function handleEnterPress(text) {
                ws.send(text);
                hiddenInput.value = '';
                subtitles.textContent = '';
                subtitles.classList.add('listening');
            }
        </script>
    </div>
</body>

</html>